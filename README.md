## 更新履歴
- 2025/04/15   ドライブをまたいで移動できない、Filterに一致する画像が無い場合すべて表示される問題を修正
- 2025/03/25   メタデータダイアログに選択タブ追加
- 2025/02/28   ワイルドカード作成機能追加

# これはなに？

Stable Diffusion WebUI や reforge で生成された画像の **プロンプトを確認** したり、 **ファイルを移動・コピー** するためのアプリです。\
WebUI のデフォルト設定で作成される **日付ごとのフォルダをまとめて管理** することを想定しています。

## 主な機能
- 選択したフォルダ内の すべての画像ファイル **（サブフォルダ含む）** を表示
- メタデータ（プロンプト）の表示 [サムネイル右クリック](#サムネイル)
- 空のサブフォルダを削除（ゴミ箱に移動）
- 画像ファイルの移動
- 画像コピー時に **連番を付与** 
- 画像のポジティブプロンプトからワイルドカード作成（Dynamic Prompts 用）
- **対応画像形式**：`png` / `jpeg` / `webp`

![Image](https://github.com/user-attachments/assets/649081b0-2bfe-4c19-9615-0e4bba554462)

---
## インストール方法
1. ブランチ右上の **<>Code** をクリックし、 **Download ZIP** でダウンロード
2. 日本語など **マルチバイト文字を含まないフォルダ** に解凍
3. `ImageMoverRun.bat` を実行
4. **「WindowsによってPCが保護されました」** が表示された場合：
   - **詳細情報** をクリック → `実行` をクリック
5. 依存ファイルのインストール完了後、アプリが起動

### アンインストール方法
フォルダごと削除してください。

---
## 使い方
### 起動方法
2回目以降の起動も `ImageMoverRun.bat` を実行。

1. フォルダ選択ダイアログが表示されるので、WebUIのtxt2imgフォルダ等、画像フォルダまたは親フォルダを選択して `フォルダの選択` をクリック
2. 空のサブフォルダがある場合、削除するか確認される（削除するとゴミ箱へ移動）
3. サムネイルが一覧表示される

### 画像の移動
1. サムネイルをクリックして選択状態にする
2. ウィンドウ下の `Move` をクリック
3. 移動先のフォルダを選択し `フォルダの選択` をクリック

### 画像のコピー（連番付与）
1. ウィンドウ右上の `Copy Mode` をクリック（ボタンが `Copy Mode Exit` に変わる）
2. **コピーしたい順番に** サムネイルをクリック（番号が振られる）
3. ウィンドウ右下の `Copy` をクリック
4. コピー先フォルダを選択し `フォルダの選択` をクリック
   - `振られた番号3桁` + `_` + `元のファイル名` でコピー
   - 既に連番付きファイルがある場合、**続きの番号** から振り直される
5. `Copy Mode Exit` をクリックで **コピーモード終了**

## その他の機能
### サムネイル
- **マウスオーバー** でフォルダパス表示
- **ダブルクリック** で拡大・縮小可能なプレビュー表示 [Preview mode](#preview-mode)
- **右クリック** でメタデータ表示
   - metadataタブ  
   ドラッグで選択、Ctrl＋Cまたは `Clipbord`ボタンでクリップボードにコピー  
   ![Image](https://github.com/user-attachments/assets/457aebaa-c0a5-4986-9f08-9b2660edbc7b)
   - Selectタブ  
   タグをクリックで選択、`Clipbord`ボタンで **選択したタグだけ** クリップボードにコピー（Ctrl+Cは使えません）  
   ![Image](https://github.com/user-attachments/assets/c2d0101f-9828-4356-b45f-652c9112c7df)  
   ネストされた（）等、タグの区切りが正しく認識されないことがあります  

### フィルタ機能
- **メタデータを元にフィルタリング**
  - テキストボックスに `,（カンマ）` 区切りで複数ワード入力可
  - 空白で `Filter` を押すとフィルタ解除
  - ラジオボタンで `AND`（すべてを含む）/ `OR`（いずれかを含む）を切り替え

### 並べ替え（Sort by）
- **ファイル名** または **更新日付** の昇順・降順でソート

### フォルダツリー
- クリックでフォルダ内のファイルを表示（選択状態はリセット）
- `<<` をクリックで 非表示にするとサムネイル列が+1

### `-` `+` ボタン
- サムネイルの表示列数を変更（中央に現在の列数を表示）

---
## ワイルドカード作成（Dynamic Prompts 用）
1. `Copy Mode` は **オフ** にする
2. サムネイルをクリックして画像を選択
3. ウィンドウ下の `WC Creator` をクリック
4. 別ウィンドウが開き、
   - 左側：選択したサムネイルの1枚目を表示
   - 右側：ポジティブプロンプトを **行ごとに表示**
![Image](https://github.com/user-attachments/assets/c41280a8-b132-46c9-8bf1-c147e3c7ced8)
5. 出力したい行のチェック、コメント追加が可能 [コメント出力フォーマット](#コメント出力フォーマット)
  - `Output Checked`：チェックされたプロンプトのみをOutput Previewに表示。
  - `Output All`：チェックは無視してすべてのプロンプトをOutput Previewに表示。
  - `Clipboard`：チェックされたプロンプトをクリップボードにコピー。
6. Output Previewウィンドウ
![Image](https://github.com/user-attachments/assets/b0530e8b-dc81-47e0-9739-cbe39f48b1f1)
  - 置換機能：Search Stringに検索文字列、Replace Stringに置換文字列を入力し、`Replace` をクリックで一括置換。
  - 各画像のコメント、プロンプトを編集可能。
  - `Output` ：txtファイルで出力。

---

## 設定（Config）
### cache size
- サムネイルのキャッシュ数を変更可能（デフォルト1000）
- 1000以上の画像ファイルがあり、動作が重いと感じたら画像の枚数以上に増やすと改善するかも（ただしメモリ消費量も増加）

### Preview mode
- 拡大表示方法を変更可能
- **シームレス**：ウィンドウサイズに合わせて拡大縮小
- **ホイール**：Ctrl+スクロールで拡大縮小、ドラッグで移動

### コメント出力フォーマット
- **行頭に '#' を付けて別行に出力** ：**webUIでは表示されない。** プロンプトとは別の行にコメントを出力（プロンプトの上）。
  - txtファイル\
![Image](https://github.com/user-attachments/assets/29aa43d9-4f04-47c6-b092-748eeb8dd2b5)
  - webUI\
![Image](https://github.com/user-attachments/assets/52713fad-7469-44de-8f75-1c8e7c862cc6)
- **[:100]で先頭に出力** ：**webUIで表示される。** プロンプトの先頭に'[コメント:100]'で出力。スケジュール構文を利用したもので、生成時`Sampling stepsが100未満`であれば影響をうけない。はず。
  - txtファイル\
![Image](https://github.com/user-attachments/assets/96f733d8-73d1-40f8-80b2-a0c51b94bb26)
  - webUI\
![Image](https://github.com/user-attachments/assets/fa83fd84-d6f9-4f3d-9aec-5181fe3274e7)
---
## 既知の問題
- 入れ子になった空フォルダがある場合、最下層のフォルダしか削除されない
- Filter機能はメタデータ全文検索のため、ネガティブや使われなかったWildcard（メタデータに残している場合）もヒットする

